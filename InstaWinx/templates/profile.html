{% extends "base.html" %}

{% block title %}{{ user.username }} - Perfil{% endblock %}

{% block content %}
    <div class="main-content">
        <div class="card" style="text-align: center; margin-bottom: 2rem;">
            <img src="{{ url_for('static', filename='uploads/' + user.profile_pic) }}" class="profile-pic" style="margin-bottom: 1rem;">
            <h2>{{ user.username }}</h2>
            <span class="fairy-badge fairy-{{ user.fairy_type|lower|replace(' ', '-') }}" style="margin-bottom: 1rem;">
                {{ user.fairy_type }}
            </span>
            
            {% if user.bio %}
                <p style="margin-bottom: 1.5rem;">{{ user.bio }}</p>
            {% endif %}
            
            {% if user.id != current_user.id %}
                <div style="margin-top: 1rem;">
                    {% if friendship_status == 'accepted' %}
                        <button class="btn btn-outline" disabled>
                            <i class="fas fa-check"></i> Amigos
                        </button>
                    {% elif friendship_status == 'request_sent' %}
                        <button class="btn btn-outline" disabled>
                            <i class="fas fa-clock"></i> Solicitação enviada
                        </button>
                    {% elif friendship_status == 'request_received' %}
                        <button class="btn btn-primary accept-friend-btn" data-user-id="{{ user.id }}">
                            <i class="fas fa-user-plus"></i> Aceitar solicitação
                        </button>
                    {% else %}
                        <button class="btn btn-primary add-friend-btn" data-user-id="{{ user.id }}">
                            <i class="fas fa-user-plus"></i> Adicionar amigo
                        </button>
                    {% endif %}
                </div>
            {% endif %}
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 2rem;">
            {% for post in posts %}
                <div class="glow-effect" style="aspect-ratio: 1; overflow: hidden; border-radius: 10px; cursor: pointer;"
                     onclick="window.location.href='{{ url_for('index') }}#post-{{ post.id }}'">
                    <img src="{{ url_for('static', filename='uploads/' + post.image) }}" 
                         style="width: 100%; height: 100%; object-fit: cover;">
                </div>
            {% endfor %}
        </div>
    </div>
    
    <div class="sidebar">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Sobre {{ user.username }}</h3>
            </div>
            <div style="display: flex; flex-direction: column; gap: 1rem;">
                <div>
                    <strong>Tipo de Fada:</strong>
                    <p>{{ user.fairy_type }}</p>
                </div>
                {% if user.id == current_user.id %}
                    <a href="#" class="btn btn-outline" style="width: 100%;">
                        <i class="fas fa-edit"></i> Editar perfil
                    </a>
                {% endif %}
            </div>
        </div>
        
        {% if user.id != current_user.id %}
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Amigos em comum</h3>
                </div>
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    <p style="text-align: center; color: #666;">Em breve...</p>
                </div>
            </div>
        {% endif %}
    </div>
{% endblock %}

{% block extra_js %}
    <script>
        // Adicionar/aceitar amigo
        document.querySelectorAll('.add-friend-btn, .accept-friend-btn').forEach(btn => {
            btn.addEventListener('click', async function() {
                const userId = this.dataset.userId;
                
                try {
                    const response = await fetch(`/add_friend/${userId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        if (data.action === 'requested') {
                            this.innerHTML = '<i class="fas fa-clock"></i> Solicitação enviada';
                            this.classList.remove('btn-primary');
                            this.classList.add('btn-outline');
                            this.disabled = true;
                        } else if (data.action === 'accepted') {
                            this.innerHTML = '<i class="fas fa-check"></i> Amigos';
                            this.classList.remove('btn-primary');
                            this.classList.add('btn-outline');
                            this.disabled = true;
                        }
                    } else if (data.error) {
                        alert(data.error);
                    }
                } catch (error) {
                    console.error('Error:', error);
                }
            });
        });
    </script>
{% endblock %}